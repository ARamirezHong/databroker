language: python
sudo: false
services:
- mongodb
matrix:
  include:
  - python: 2.7
  - python: 3.4
  - python: 3.5
before_install:
- if [ ${TRAVIS_PYTHON_VERSION:0:1} == "2" ]; then
    wget http://repo.continuum.io/miniconda/Miniconda-3.5.5-Linux-x86_64.sh -O miniconda.sh;
  else
    wget http://repo.continuum.io/miniconda/Miniconda3-3.5.5-Linux-x86_64.sh -O miniconda.sh;
  fi;
- chmod +x miniconda.sh
- "./miniconda.sh -b -p /home/travis/mc"
- export PATH=/home/travis/mc/bin:$PATH
- export MDS_HOST=localhost
- export MDS_DATABASE=test
- export MDS_TIMEZONE=US/Eastern
- mkdir -p /home/travis/.config/metadatastore
- 'echo ''port: 27017'' > /home/travis/.config/metadatastore/connection.yml'
install:
- export GIT_FULL_HASH=`git rev-parse HEAD`
- conda config --set always_yes true
- conda update conda --yes
- conda config --add channels lightsource2
- conda create -n testenv pip nose python=$TRAVIS_PYTHON_VERSION "pymongo=2.9" six pyyaml numpy pandas jinja2 mongoengine boltons prettytable humanize
- source activate testenv
- pip install coveralls codecov
- python setup.py install
- git describe
- python -c "import metadatastore; print(metadatastore.__version__)"
script:
- python run_tests.py -v
- git fetch --unshallow
- conda install -n root conda-build jinja2 anaconda-client
- export CONDA_BUILD_COMMAND="conda build conda-recipe --python=$TRAVIS_PYTHON_VERSION"
- "$CONDA_BUILD_COMMAND"
after_success:
- coveralls
- codecov
- source deactivate
- git clone https://github.com/ericdill/travis-little-helper

- if [ "${TRAVIS_PULL_REQUEST}" = "false" ]; then
    $CONDA_BUILD_COMMAND --output | bash travis-little-helper/anaconda-version-string.sh > version;
    anaconda login --username $USER --password $PASS --hostname "$TRAVIS_PYTHON_VERSION-`cat version`";
    bash travis-little-helper/clean-anaconda-channel.sh lightsource2-dev metadatastore true;
    anaconda upload -u lightsource2-dev `$CONDA_BUILD_COMMAND --output`;
    anaconda logout;
  fi;
env:
  global:
    secure: "Fu8j9IR5+1dSNI20MEJbnPzz8bEvkchYw5NpDPnE2LhYNI+5F9FfXp0gDv79w10kkp+sBZFvm6lEzv/u7inryySBLy/Oi0XvjO6BWf6cYsHcLmfIzyGMVhWQC8Rt2SMvJlDaEwpEOIlm/7x+ME5LnXj5yU9Ixvnk51kQa5QjOUs="
    secure: "KZycohzXLRIkfYpKo35p8jGBH4dozQP0CYR3cu/h2CoBWMu2UsNsMx6mW1ZDWbr6dWCMZhC7pui+8K2RF5tgT97L/DHOzEhzuhjrcBWiJTKo2oGAMEUeeaLgUXynfhOZAg4pgXZAdtbtLQ7EwAu7eXID3Z4Nd2H2t9NUk690Fmk="

